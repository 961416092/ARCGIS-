<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

    <title>Dot density - 4.11</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.11/esri/themes/dark/main.css" />

    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }
    </style>

    <script src="https://js.arcgis.com/4.11/"></script>

    <script>
        require([
            "esri/WebMap",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/renderers/DotDensityRenderer",
            "esri/widgets/Legend",
            "esri/widgets/Bookmarks",
            "esri/widgets/Expand"
        ], function (
            WebMap,
            MapView,
            FeatureLayer,
            DotDensityRenderer,
            Legend,
            Bookmarks,
            Expand
        ) {
            const map = new WebMap({
                basemap: "topo"
            });

            const view = new MapView({
                container: "viewDiv",
                map: map,
                highlightOptions: {
                    fillOpacity: 0,
                    color: [50, 50, 50]
                },
                popup: {
                    dockEnabled: true,
                    dockOptions: {
                        position: "top-right",
                        breakpoint: false
                    }
                },
                constraints: {
                    maxScale: 35000
                }
            });

            view.when().then(function () {
                const dotDensityRenderer = new DotDensityRenderer({
                    referenceDotValue: 100,
                    outline: null,
                    // referenceScale: 500000, // 1:577,790 view scale
                    legendOptions: {
                        unit: "people"
                    },
                    blendDots: false,
                    attributes: [
                        {
                            field: "M099_07",
                            color: "#CC8800",
                            label: "Two or more races"
                        }, {
                            field: "M163_07",
                            color: "#008800",
                            label: "Two or more races"
                        }
                        // {
                        //     field: "B03002_009E",
                        //     color: "#96f7ef",
                        //     label: "Two or more races"
                        // }
                    ],
                    visualVariables: [{
                        type: "size",
                        target: "outline",
                        valueExpression: "$view.scale",
                        stops: [
                            { size: 15, value: 377790 },
                            { size: 75, value: 477790 },
                            { size: 375, value: 577790 },
                            { size: 0, value: 677790 },
                        ]
                    }]
                });

                // Add renderer to the layer and define a popup template
                const url =
                    "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/USA_County_Crops_2007/FeatureServer/0";
                const layer = new FeatureLayer({
                    url: url,
                    minScale: 20000000,
                    maxScale: 35000,
                    title: "Current Population Estimates (ACS)",

                    renderer: dotDensityRenderer
                });

                map.add(layer);

                view.ui.add(
                    [
                        new Expand({
                            view: view,
                            content: new Legend({ view: view }),
                            group: "top-left",
                            expanded: true
                        }),
                        new Expand({
                            view: view,
                            content: new Bookmarks({ view: view }),
                            group: "top-left"
                        })
                    ],
                    "top-left"
                );
            });
        });
    </script>
</head>

<body>
    <div id="viewDiv"></div>
</body>

</html>